# MIoT Discovery with Cloud Integration

å®Œæ•´çš„å°ç±³IoTè®¾å¤‡å‘ç°å’Œä¿¡æ¯æŸ¥è¯¢å·¥å…· - ç°åœ¨æ”¯æŒäº‘ç«¯APIé›†æˆï¼

## ğŸ‰ æ–°åŠŸèƒ½

### v2.0 - äº‘ç«¯APIé›†æˆ

- âœ… **å®Œæ•´è®¾å¤‡ä¿¡æ¯**: è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„è®¾å¤‡åç§°
- âœ… **RSA+AESåŠ å¯†**: å®‰å…¨çš„APIé€šä¿¡
- âœ… **è‡ªåŠ¨ä¿¡æ¯å…³è”**: LANå‘ç° + äº‘ç«¯ä¿¡æ¯æŸ¥è¯¢
- âœ… **è¯¦ç»†è®¾å¤‡å‚æ•°**: å‹å·ã€å›ºä»¶ç‰ˆæœ¬ã€WiFiä¿¡æ¯ç­‰

## ğŸ“¦ ç³»ç»Ÿè¦æ±‚

### å¿…éœ€ä¾èµ–

```bash
# macOS
brew install cmake openssl curl

# Ubuntu/Debian
sudo apt-get install cmake libssl-dev libcurl4-openssl-dev

# CentOS/RHEL
sudo yum install cmake openssl-devel libcurl-devel
```

### ç¼–è¯‘è¦æ±‚

- C++17æˆ–æ›´é«˜ç‰ˆæœ¬
- CMake 3.10+
- OpenSSL 1.1.0+
- libcurl 7.x+

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡Access Token

é¦–å…ˆéœ€è¦è·å–å°ç±³è´¦å·çš„access_tokenã€‚æ‚¨å¯ä»¥ï¼š

- æ–¹å¼1: è¿è¡Œä¹‹å‰åˆ›å»ºçš„tokenè·å–ç¨‹åº
- æ–¹å¼2: ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–
- æ–¹å¼3: ä½¿ç”¨Pythonè„šæœ¬è·å–

å°†tokenä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå¦‚ `token.txt`ï¼‰ï¼š

```bash
echo "your_access_token_here" > token.txt
```

### 2. ç¼–è¯‘é¡¹ç›®

```bash
cd /Users/jiadiy/Workspace/miot_camera_bridge
./build.sh
```

### 3. è¿è¡Œå®Œæ•´ç‰ˆï¼ˆLAN + Cloudï¼‰

```bash
cd build

# ä½¿ç”¨tokenæ–‡ä»¶
./miot_discovery_with_cloud -f ../token.txt

# æˆ–ç›´æ¥æŒ‡å®štoken
./miot_discovery_with_cloud -t "your_access_token_here"

# æŒ‡å®šç½‘ç»œæ¥å£
./miot_discovery_with_cloud -f ../token.txt -i en0

# æŒ‡å®šäº‘æœåŠ¡å™¨åŒºåŸŸ
./miot_discovery_with_cloud -f ../token.txt -s cn
```

### 4. æˆ–è¿è¡ŒåŸºç¡€ç‰ˆï¼ˆä»…LANï¼‰

```bash
./miot_lan_discovery_demo -i en0
```

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### å®Œæ•´ç‰ˆè¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         Discovered MIoT Devices (With Cloud Info)                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Status â”‚ Device Name             â”‚ Model                    â”‚ IP Address       â”‚ Interface      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸŸ¢ ON  â”‚ å®¢å…æ‘„åƒå¤´              â”‚ xiaomi.camera.082ac1     â”‚ 192.168.1.100   â”‚ en0            â•‘
â•‘ ğŸŸ¢ ON  â”‚ å§å®¤æ‘„åƒå¤´              â”‚ chuangmi.camera.068ac1   â”‚ 192.168.1.101   â”‚ en0            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Total: 2 devices (LAN), 2 with cloud info                                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        Device Details                                   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  DID:          123456789012345678                                      â•‘
â•‘  Name:         å®¢å…æ‘„åƒå¤´                                              â•‘
â•‘  Model:        xiaomi.camera.082ac1                                    â•‘
â•‘  Manufacturer: xiaomi                                                  â•‘
â•‘  Status:       Online                                                  â•‘
â•‘  Local IP:     192.168.1.100                                           â•‘
â•‘  SSID:         MyWiFi                                                  â•‘
â•‘  RSSI:         -45 dBm                                                 â•‘
â•‘  Firmware:     1.2.3                                                   â•‘
â•‘  Token:        abc123xyz456...                                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ”‘ å‘½ä»¤è¡Œå‚æ•°

### miot_discovery_with_cloudï¼ˆå®Œæ•´ç‰ˆï¼‰

| å‚æ•° | è¯´æ˜ | å¿…éœ€ | ç¤ºä¾‹ |
|------|------|------|------|
| `-t, --token <token>` | Access token | æ˜¯ | `-t "abc123..."` |
| `-f, --token-file <path>` | Tokenæ–‡ä»¶è·¯å¾„ | æ˜¯ | `-f token.txt` |
| `-i, --interface <name>` | ç½‘ç»œæ¥å£ | å¦ | `-i en0` |
| `-s, --server <region>` | äº‘æœåŠ¡å™¨åŒºåŸŸ | å¦ | `-s cn` |
| `--timeout <seconds>` | è®¾å¤‡è¶…æ—¶æ—¶é—´ | å¦ | `--timeout 120` |
| `-h, --help` | æ˜¾ç¤ºå¸®åŠ© | å¦ | `-h` |

**æ³¨æ„**: `-t` å’Œ `-f` å¿…é¡»æä¾›å…¶ä¸­ä¸€ä¸ª

### miot_lan_discovery_demoï¼ˆåŸºç¡€ç‰ˆï¼‰

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `-i, --interface <name>` | ç½‘ç»œæ¥å£ | `-i en0` |
| `-d, --did <number>` | è™šæ‹Ÿè®¾å¤‡ID | `-d 123456` |
| `-t, --timeout <seconds>` | è®¾å¤‡è¶…æ—¶ | `-t 120` |
| `--min-interval <secs>` | æœ€å°æ‰«æé—´éš” | `--min-interval 5` |
| `--max-interval <secs>` | æœ€å¤§æ‰«æé—´éš” | `--max-interval 45` |

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  miot_discovery_with_cloud (ä¸»ç¨‹åº)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ MIoTLanDiscovery  â”‚  â”‚ MIoTCloudClient  â”‚   â”‚
â”‚  â”‚                   â”‚  â”‚                  â”‚   â”‚
â”‚  â”‚ â€¢ UDPå¹¿æ’­        â”‚  â”‚ â€¢ RSAåŠ å¯†       â”‚   â”‚
â”‚  â”‚ â€¢ è®¾å¤‡å‘ç°       â”‚  â”‚ â€¢ AESåŠ å¯†       â”‚   â”‚
â”‚  â”‚ â€¢ çŠ¶æ€ç›‘æ§       â”‚  â”‚ â€¢ HTTP POST     â”‚   â”‚
â”‚  â”‚ â€¢ IPåœ°å€         â”‚  â”‚ â€¢ JSONè§£æ      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“                      â†“               â”‚
â”‚      å±€åŸŸç½‘è®¾å¤‡åˆ—è¡¨          äº‘ç«¯è®¾å¤‡è¯¦æƒ…         â”‚
â”‚           â†“                      â†“               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       åˆå¹¶æ˜¾ç¤ºå®Œæ•´è®¾å¤‡ä¿¡æ¯               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠ å¯†æµç¨‹

```
1. ç”ŸæˆéšæœºAESå¯†é’¥ï¼ˆ16å­—èŠ‚ï¼‰
           â†“
2. ç”¨å°ç±³å…¬é’¥RSAåŠ å¯†AESå¯†é’¥
           â†“
3. Base64ç¼–ç  â†’ X-Client-Secretå¤´
           â†“
4. è¯·æ±‚æ•°æ®JSONå­—ç¬¦ä¸²
           â†“
5. PKCS7å¡«å……åˆ°128ä½
           â†“
6. AES-CBCåŠ å¯†ï¼ˆå¯†é’¥åŒæ—¶ä½œä¸ºIVï¼‰
           â†“
7. Base64ç¼–ç  â†’ HTTP Body
           â†“
8. POSTåˆ°å°ç±³äº‘æœåŠ¡å™¨
           â†“
9. å“åº”Base64è§£ç  â†’ AESè§£å¯† â†’ JSON
```

## ğŸ“ APIè¯¦æƒ…

### è°ƒç”¨çš„å°ç±³äº‘API

- **Endpoint**: `/app/v2/home/device_list_page`
- **Method**: POST
- **Host**: `https://mico.api.mijia.tech` (ä¸­å›½åŒº)
- **åŠ å¯†**: RSA + AES-128-CBC
- **è®¤è¯**: Bearer Token

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "limit": 200,
  "get_split_device": true,
  "dids": ["123456789", "987654321"]
}
```

### å“åº”å­—æ®µ

| å­—æ®µ | è¯´æ˜ | ç±»å‹ |
|------|------|------|
| `did` | è®¾å¤‡ID | string |
| `name` | è®¾å¤‡åç§°ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰ | string |
| `model` | è®¾å¤‡å‹å· | string |
| `token` | è®¾å¤‡token | string |
| `local_ip` | æœ¬åœ°IPåœ°å€ | string |
| `ssid` | WiFiåç§° | string |
| `rssi` | ä¿¡å·å¼ºåº¦ | int |
| `fw_version` | å›ºä»¶ç‰ˆæœ¬ | string |
| `isOnline` | åœ¨çº¿çŠ¶æ€ | bool |

## ğŸ”§ å¼€å‘é›†æˆ

### ä½œä¸ºåº“ä½¿ç”¨

```cpp
#include "miot_lan_device.h"
#include "miot_cloud_client.h"

// 1. åˆ›å»ºLANå‘ç°å™¨
miot::MIoTLanDiscovery discovery({"en0"});
discovery.start();

// 2. åˆ›å»ºäº‘å®¢æˆ·ç«¯
miot::MIoTCloudClient cloud_client(access_token, "cn");
cloud_client.init();

// 3. ç­‰å¾…å‘ç°è®¾å¤‡
std::this_thread::sleep_for(std::chrono::seconds(5));
auto lan_devices = discovery.get_devices();

// 4. æŸ¥è¯¢äº‘ç«¯ä¿¡æ¯
std::vector<std::string> dids;
for (const auto& pair : lan_devices) {
    dids.push_back(pair.first);
}
auto cloud_devices = cloud_client.get_devices(dids);

// 5. ä½¿ç”¨è®¾å¤‡ä¿¡æ¯
for (const auto& pair : cloud_devices) {
    std::cout << "Device: " << pair.second.name 
              << " (" << pair.second.model << ")" << std::endl;
}
```

### CMakeé›†æˆ

```cmake
add_subdirectory(miot_camera_bridge)

target_link_libraries(your_app
    miot_lan_device
    miot_cloud_client
)
```

## ğŸ› æ•…éšœæ’æŸ¥

### 1. ç¼–è¯‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°OpenSSL

```bash
# macOS
brew install openssl
export OPENSSL_ROOT_DIR=$(brew --prefix openssl)

# ç„¶åé‡æ–°ç¼–è¯‘
rm -rf build
./build.sh
```

### 2. ç¼–è¯‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°libcurl

```bash
# macOS
brew install curl

# Linux
sudo apt-get install libcurl4-openssl-dev
```

### 3. è¿è¡Œæ—¶é”™è¯¯ï¼šInvalid access token

æ£€æŸ¥tokenæ˜¯å¦ï¼š
- æ­£ç¡®å¤åˆ¶ï¼ˆæ— å¤šä½™ç©ºæ ¼ï¼‰
- æœªè¿‡æœŸï¼ˆaccess_tokené€šå¸¸30å¤©æœ‰æ•ˆï¼‰
- åŒºåŸŸæ­£ç¡®ï¼ˆ-s cn/de/usï¼‰

### 4. äº‘APIè¿”å›ç©ºæ•°æ®

å¯èƒ½åŸå› ï¼š
- Tokenæ— æ•ˆæˆ–è¿‡æœŸ
- ç½‘ç»œè¿æ¥é—®é¢˜
- è®¾å¤‡ä¸åœ¨æ‚¨çš„è´¦å·ä¸‹

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
miot_camera_bridge/
â”œâ”€â”€ miot_lan_device.h          # LANå‘ç°å¤´æ–‡ä»¶
â”œâ”€â”€ miot_lan_device.cpp        # LANå‘ç°å®ç°
â”œâ”€â”€ miot_cloud_client.h        # äº‘APIå¤´æ–‡ä»¶
â”œâ”€â”€ miot_cloud_client.cpp      # äº‘APIå®ç°ï¼ˆRSA+AESï¼‰
â”œâ”€â”€ main.cpp                   # åŸºç¡€ç‰ˆç¤ºä¾‹ï¼ˆä»…LANï¼‰
â”œâ”€â”€ main_with_cloud.cpp        # å®Œæ•´ç‰ˆç¤ºä¾‹ï¼ˆLAN+Cloudï¼‰
â”œâ”€â”€ CMakeLists.txt             # æ„å»ºé…ç½®
â”œâ”€â”€ build.sh                   # æ„å»ºè„šæœ¬
â”œâ”€â”€ README_CLOUD.md            # æœ¬æ–‡æ¡£
â””â”€â”€ build/                     # æ„å»ºè¾“å‡º
    â”œâ”€â”€ miot_lan_discovery_demo        # åŸºç¡€ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ miot_discovery_with_cloud      # å®Œæ•´ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ libmiot_lan_device.a           # LANå‘ç°é™æ€åº“
    â””â”€â”€ libmiot_cloud_client.a         # äº‘APIé™æ€åº“
```

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆäº†è®¾å¤‡å‘ç°å’Œä¿¡æ¯æŸ¥è¯¢åï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… **æ‘„åƒå¤´è¿æ¥**: ä½¿ç”¨DIDã€Tokenå’ŒIPè¿æ¥æ‘„åƒå¤´
2. âœ… **è§†é¢‘æµè·å–**: P2Påè®®è·å–å®æ—¶è§†é¢‘
3. âœ… **è®¾å¤‡æ§åˆ¶**: è°ƒç”¨å°ç±³äº‘APIæ§åˆ¶è®¾å¤‡
4. âœ… **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§è®¾å¤‡åœ¨çº¿çŠ¶æ€

## ğŸ“š å‚è€ƒèµ„æ–™

- [å°ç±³IoTå¼€å‘è€…å¹³å°](https://iot.mi.com/)
- [åŸPythonå®ç°](https://github.com/MiEcosystem/xiaomi-miloco)
- [OpenSSLæ–‡æ¡£](https://www.openssl.org/docs/)
- [libcurlæ–‡æ¡£](https://curl.se/libcurl/)

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®åŸºäº [Xiaomi Miloco](https://github.com/MiEcosystem/xiaomi-miloco) çš„Pythonå®ç°ï¼Œç§»æ¤åˆ°C++ä»¥æä¾›æ›´é«˜æ€§èƒ½å’Œæ›´çµæ´»çš„é›†æˆæ–¹å¼ã€‚

---

**Happy Coding!** ğŸ‰

